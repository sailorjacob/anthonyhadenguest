// Gallery data
const galleryData = {
    'smile-wars': [
        {
            id: 1,
            title: 'Smile Wars #1',
            description: 'Social Commentary',
            src: 'https://drive.google.com/uc?export=view&id=15qBDc3LPXkE1W5mcnXw9BcKfibgZ-cWu',
            series: 'smile-wars'
        },
        {
            id: 2,
            title: 'Smile Wars #2',
            description: 'Cultural Observation',
            src: 'https://drive.google.com/uc?export=view&id=1HdzxIvntWTRYEetW3x-oLvSXFuoijq1b',
            series: 'smile-wars'
        },
        {
            id: 3,
            title: 'Smile Wars #3',
            description: 'Social Dynamics',
            src: 'https://drive.google.com/uc?export=view&id=1K8cpyUtTpTLxwyYGhL1E5JW8jxcXS1bV',
            series: 'smile-wars'
        },
        {
            id: 4,
            title: 'Smile Wars #4',
            description: 'Contemporary Critique',
            src: 'https://drive.google.com/uc?export=view&id=1Lt-eHT25vxcP8L_Lw_oaFgCK5yQ6qT86',
            series: 'smile-wars'
        },
        {
            id: 5,
            title: 'Smile Wars #5',
            description: 'Visual Commentary',
            src: 'https://drive.google.com/uc?export=view&id=1M9C7al8RI3b0YGHgbSKuFWMekND0kbHZ',
            series: 'smile-wars'
        },
        {
            id: 6,
            title: 'Smile Wars #6',
            description: 'Satirical Insight',
            src: 'https://drive.google.com/uc?export=view&id=1hVZe2oaaoMe5_RdLtzsKDBVQeJSkk2_-',
            series: 'smile-wars'
        },
        {
            id: 7,
            title: 'Smile Wars #7',
            description: 'Social Observation',
            src: 'https://drive.google.com/uc?export=view&id=1upzI1GpCAOltJROvnje_7j0h0M8hbCUe',
            series: 'smile-wars'
        }
    ],
    'things-next': [
        {
            id: 8,
            title: 'Things Next #1',
            description: 'Future Dynamics',
            src: 'https://drive.google.com/uc?export=view&id=1A7QXz0vClnkrnofbuxVRtDqeDls8rcKc',
            series: 'things-next'
        },
        {
            id: 9,
            title: 'Things Next #2',
            description: 'Cultural Evolution',
            src: 'https://drive.google.com/uc?export=view&id=1BYku9SYIAPNbaBWPuVzTDhdR_0C4VJwp',
            series: 'things-next'
        },
        {
            id: 10,
            title: 'Things Next #3',
            description: 'Social Prediction',
            src: 'https://drive.google.com/uc?export=view&id=1E9M_YCUHsW1-SurimINJnMrC1ZahozPn',
            series: 'things-next'
        },
        {
            id: 11,
            title: 'Things Next #4',
            description: 'Future Commentary',
            src: 'https://drive.google.com/uc?export=view&id=1F7H7caYwGZkp8EE4DK-aO9diwIvg0Oii',
            series: 'things-next'
        },
        {
            id: 12,
            title: 'Things Next #5',
            description: 'Emerging Trends',
            src: 'https://drive.google.com/uc?export=view&id=1HkSM-aVwpBUz4KVRDX__XSNIBMHQe7xI',
            series: 'things-next'
        },
        {
            id: 13,
            title: 'Things Next #6',
            description: 'Progressive Insight',
            src: 'https://drive.google.com/uc?export=view&id=1RMcuXx5w-I_5WqgdI8Y3urA531XB8Sn-',
            series: 'things-next'
        },
        {
            id: 14,
            title: 'Things Next #7',
            description: 'Tomorrow\'s Satire',
            src: 'https://drive.google.com/uc?export=view&id=1UoxtKGQKvk5bFF4qyYiROtwhSRh7iFh1',
            series: 'things-next'
        },
        {
            id: 15,
            title: 'Things Next #8',
            description: 'Future Vision',
            src: 'https://drive.google.com/uc?export=view&id=1ViPloe6k_qM8WgbNe2_9wFmXwXmONh8',
            series: 'things-next'
        },
        {
            id: 16,
            title: 'Things Next #9',
            description: 'Cultural Forecast',
            src: 'https://drive.google.com/uc?export=view&id=1WwC53TAn82qB6Rv-acRJBfT_D1aTB25r',
            series: 'things-next'
        },
        {
            id: 17,
            title: 'Things Next #10',
            description: 'Next Generation',
            src: 'https://drive.google.com/uc?export=view&id=1dh1gacfbzJIB-CfYcJSth3sQ6MtIlfj5',
            series: 'things-next'
        },
        {
            id: 18,
            title: 'Things Next #11',
            description: 'Forward Thinking',
            src: 'https://drive.google.com/uc?export=view&id=1fH3GrsjEWQf47cH79ND4CDniMVzTa-Wr',
            series: 'things-next'
        },
        {
            id: 19,
            title: 'Things Next #12',
            description: 'Future Perspective',
            src: 'https://drive.google.com/uc?export=view&id=1i7uU-qR3ciIqABIVxhK-sm9DLBMXxjmP',
            series: 'things-next'
        },
        {
            id: 20,
            title: 'Things Next #13',
            description: 'Anticipatory Art',
            src: 'https://drive.google.com/uc?export=view&id=1nReW3MK6B7M2ZuKcebvNSz3JlUu_Kl1z',
            series: 'things-next'
        },
        {
            id: 21,
            title: 'Things Next #14',
            description: 'Future Narrative',
            src: 'https://drive.google.com/uc?export=view&id=1o1kWyHFI_c7FmqoaNqM5p5HUiR4TmIoH',
            series: 'things-next'
        },
        {
            id: 22,
            title: 'Things Next #15',
            description: 'Tomorrow\'s Truth',
            src: 'https://drive.google.com/uc?export=view&id=1tMMHlBCn6ZX0DvkPL2dXvaIRQO4j1ikM',
            series: 'things-next'
        }
    ]
};

// Flatten all gallery data for easier access
const allImages = [...galleryData['smile-wars'], ...galleryData['things-next']];

// DOM Elements
const tabBtns = document.querySelectorAll('.tab-btn');
const gallerySections = document.querySelectorAll('.gallery-section');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize both carousels
    const smileWarsCarousel = new Carousel('smile-wars-track', 'smile-wars-dots');
    const thingsNextCarousel = new Carousel('things-next-track', 'things-next-dots');
    
    // Setup other functionality
    setupNavbarScroll();
    setupImageLoading();
    setupScrollAnimations();
});

// Setup tab navigation
function setupTabNavigation() {
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetSeries = btn.getAttribute('data-series');
            switchToSeries(targetSeries);
            setActiveTab(btn);
        });
    });
}

// Switch to specific series
function switchToSeries(seriesName) {
    gallerySections.forEach(section => {
        if (section.id === seriesName) {
            section.classList.add('active');
        } else {
            section.classList.remove('active');
        }
    });
}

// Set active tab
function setActiveTab(activeBtn) {
    tabBtns.forEach(btn => btn.classList.remove('active'));
    activeBtn.classList.add('active');
}

// Setup scroll animations
function setupScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Observe gallery sections for scroll animations
    document.querySelectorAll('.gallery-section').forEach(section => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(30px)';
        section.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
        observer.observe(section);
    });
}

// Navbar scroll effect
function setupNavbarScroll() {
    window.addEventListener('scroll', () => {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 100) {
            navbar.style.background = 'rgba(255, 255, 255, 0.98)';
            navbar.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
        } else {
            navbar.style.background = 'rgba(255, 255, 255, 0.95)';
            navbar.style.boxShadow = 'none';
        }
    });
}

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            const headerHeight = document.querySelector('.navbar').offsetHeight;
            const targetPosition = target.offsetTop - headerHeight - 20;
            
            window.scrollTo({
                top: targetPosition,
                behavior: 'smooth'
            });
        }
    });
});

// Enhanced iframe loading
function setupIframeLoading() {
    const iframes = document.querySelectorAll('.cartoon-frame iframe');
    
    iframes.forEach(iframe => {
        iframe.addEventListener('load', function() {
            this.style.opacity = '1';
            this.style.transition = 'opacity 0.3s ease';
        });
        
        // Set initial opacity
        iframe.style.opacity = '0';
    });
}

// Initialize iframe loading
setupIframeLoading();

// Error handling for iframes
document.querySelectorAll('.cartoon-frame iframe').forEach(iframe => {
    iframe.addEventListener('error', function() {
        const parent = this.closest('.cartoon-frame');
        if (parent) {
            parent.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    background: #f8f9fa;
                    color: #6b7280;
                    font-style: italic;
                    text-align: center;
                    padding: 2rem;
                ">
                    <p>Cartoon temporarily unavailable</p>
                </div>
            `;
        }
    });
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        const currentActiveTab = document.querySelector('.tab-btn.active');
        const allTabs = Array.from(tabBtns);
        const currentIndex = allTabs.indexOf(currentActiveTab);
        
        let nextIndex;
        if (e.key === 'ArrowLeft') {
            nextIndex = currentIndex > 0 ? currentIndex - 1 : allTabs.length - 1;
        } else {
            nextIndex = currentIndex < allTabs.length - 1 ? currentIndex + 1 : 0;
        }
        
        allTabs[nextIndex].click();
    }
});

// Analytics tracking (placeholder)
function trackGalleryInteraction(action, data) {
    console.log(`Gallery interaction: ${action}`, data);
}

// Track tab switches
const originalSwitchToSeries = switchToSeries;
switchToSeries = function(seriesName) {
    trackGalleryInteraction('tab_switch', { series: seriesName });
    return originalSwitchToSeries.call(this, seriesName);
};

// Performance optimization: Lazy load iframes
function setupLazyLoading() {
    const iframeObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const iframe = entry.target;
                if (iframe.dataset.src) {
                    iframe.src = iframe.dataset.src;
                    iframe.removeAttribute('data-src');
                    iframeObserver.unobserve(iframe);
                }
            }
        });
    }, {
        rootMargin: '50px'
    });

    // For future implementation of lazy loading
    document.querySelectorAll('iframe[data-src]').forEach(iframe => {
        iframeObserver.observe(iframe);
    });
}

// Initialize lazy loading
setupLazyLoading();

// Responsive behavior
function handleResize() {
    // Adjust iframe heights on mobile if needed
    if (window.innerWidth <= 480) {
        document.querySelectorAll('.cartoon-frame').forEach(frame => {
            frame.style.height = '250px';
        });
    } else {
        document.querySelectorAll('.cartoon-frame').forEach(frame => {
            frame.style.height = '300px';
        });
    }
}

window.addEventListener('resize', handleResize);
handleResize(); // Initial call 

// Carousel functionality
class Carousel {
    constructor(trackId, dotsId) {
        this.track = document.getElementById(trackId);
        this.dotsContainer = document.getElementById(dotsId);
        this.slides = this.track.querySelectorAll('.cartoon-slide');
        this.prevBtn = document.querySelector(`[data-carousel="${trackId}"].prev-btn`);
        this.nextBtn = document.querySelector(`[data-carousel="${trackId}"].next-btn`);
        
        this.currentIndex = 0;
        this.totalSlides = this.slides.length;
        
        this.init();
    }
    
    init() {
        this.createDots();
        this.setupEventListeners();
        this.updateCarousel();
        this.setupSwipeSupport();
    }
    
    createDots() {
        this.dotsContainer.innerHTML = '';
        for (let i = 0; i < this.totalSlides; i++) {
            const dot = document.createElement('div');
            dot.classList.add('dot');
            if (i === 0) dot.classList.add('active');
            dot.addEventListener('click', () => this.goToSlide(i));
            this.dotsContainer.appendChild(dot);
        }
        this.dots = this.dotsContainer.querySelectorAll('.dot');
    }
    
    setupEventListeners() {
        this.prevBtn.addEventListener('click', () => this.prevSlide());
        this.nextBtn.addEventListener('click', () => this.nextSlide());
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (this.isInView()) {
                if (e.key === 'ArrowLeft') this.prevSlide();
                if (e.key === 'ArrowRight') this.nextSlide();
            }
        });
    }
    
    setupSwipeSupport() {
        let startX = 0;
        let endX = 0;
        let isDragging = false;
        
        this.track.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
        });
        
        this.track.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
        });
        
        this.track.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            endX = e.changedTouches[0].clientX;
            this.handleSwipe(startX, endX);
            isDragging = false;
        });
        
        // Mouse drag support for desktop
        this.track.addEventListener('mousedown', (e) => {
            startX = e.clientX;
            isDragging = true;
            this.track.style.cursor = 'grabbing';
        });
        
        this.track.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
        });
        
        this.track.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            endX = e.clientX;
            this.handleSwipe(startX, endX);
            isDragging = false;
            this.track.style.cursor = 'grab';
        });
        
        this.track.addEventListener('mouseleave', () => {
            if (isDragging) {
                isDragging = false;
                this.track.style.cursor = 'grab';
            }
        });
    }
    
    handleSwipe(startX, endX) {
        const threshold = 50;
        const diff = startX - endX;
        
        if (Math.abs(diff) > threshold) {
            if (diff > 0) {
                this.nextSlide();
            } else {
                this.prevSlide();
            }
        }
    }
    
    isInView() {
        const rect = this.track.getBoundingClientRect();
        return rect.top < window.innerHeight && rect.bottom > 0;
    }
    
    goToSlide(index) {
        this.currentIndex = index;
        this.updateCarousel();
    }
    
    nextSlide() {
        this.currentIndex = (this.currentIndex + 1) % this.totalSlides;
        this.updateCarousel();
    }
    
    prevSlide() {
        this.currentIndex = (this.currentIndex - 1 + this.totalSlides) % this.totalSlides;
        this.updateCarousel();
    }
    
    updateCarousel() {
        const translateX = -this.currentIndex * 100;
        this.track.style.transform = `translateX(${translateX}%)`;
        
        // Update dots
        this.dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === this.currentIndex);
        });
        
        // Update button states
        this.updateButtonStates();
    }
    
    updateButtonStates() {
        // Always enable buttons for infinite loop
        this.prevBtn.disabled = false;
        this.nextBtn.disabled = false;
    }
}

// Auto-play functionality (optional)
function setupAutoPlay(carousel, interval = 5000) {
    let autoPlayTimer;
    
    function startAutoPlay() {
        autoPlayTimer = setInterval(() => {
            carousel.nextSlide();
        }, interval);
    }
    
    function stopAutoPlay() {
        clearInterval(autoPlayTimer);
    }
    
    // Start auto-play
    startAutoPlay();
    
    // Pause on hover
    carousel.track.addEventListener('mouseenter', stopAutoPlay);
    carousel.track.addEventListener('mouseleave', startAutoPlay);
    
    // Pause on touch
    carousel.track.addEventListener('touchstart', stopAutoPlay);
    carousel.track.addEventListener('touchend', () => {
        setTimeout(startAutoPlay, 3000); // Resume after 3 seconds
    });
    
    // Pause when not in view
    const pauseObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                startAutoPlay();
            } else {
                stopAutoPlay();
            }
        });
    });
    
    pauseObserver.observe(carousel.track);
}

// Image loading with error handling
function setupImageLoading() {
    const images = document.querySelectorAll('.cartoon-slide img');
    
    images.forEach(img => {
        img.addEventListener('load', function() {
            this.style.opacity = '1';
            this.closest('.cartoon-slide').classList.remove('loading');
        });
        
        img.addEventListener('error', function() {
            const slide = this.closest('.cartoon-slide');
            slide.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    background: var(--secondary-color);
                    color: var(--text-light);
                    font-style: italic;
                    text-align: center;
                    padding: 2rem;
                ">
                    <p>Cartoon temporarily unavailable</p>
                </div>
            `;
        });
        
        // Set initial loading state
        img.style.opacity = '0';
        img.closest('.cartoon-slide').classList.add('loading');
    });
}

// Preload images for better performance
function preloadImages() {
    const images = document.querySelectorAll('.cartoon-slide img');
    images.forEach(img => {
        const imageObj = new Image();
        imageObj.src = img.src;
    });
}

// Initialize preloading after a short delay
setTimeout(preloadImages, 1000);

// Analytics tracking (placeholder)
function trackCarouselInteraction(action, data) {
    console.log(`Carousel interaction: ${action}`, data);
}

// Performance optimization
function optimizePerformance() {
    // Lazy load images that are not immediately visible
    const lazyImages = document.querySelectorAll('.cartoon-slide img[loading="lazy"]');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });

        lazyImages.forEach(img => imageObserver.observe(img));
    }
}

// Initialize performance optimizations
optimizePerformance(); 